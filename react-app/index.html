<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- ‚≠ê CACHE BUSTING META TAGS SEULEMENT -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="app-version" content="3.5.1" />
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1F2937" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Synergia" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  
  <!-- Manifest PWA -->
  <link rel="manifest" href="/manifest.json" />
  
  <title>Synergia v3.5 - Gamification & Productivit√©</title>
  
  <!-- SEO Meta -->
  <meta name="description" content="Synergia - Plateforme de gamification pour booster votre productivit√© en √©quipe" />
  <meta name="keywords" content="gamification, productivit√©, √©quipe, t√¢ches, XP, badges" />
  <meta name="author" content="Synergia Team" />
  
  <!-- Open Graph -->
  <meta property="og:title" content="Synergia v3.5 - Gamification & Productivit√©" />
  <meta property="og:description" content="Transformez vos t√¢ches en aventure avec notre syst√®me de gamification intelligent" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://rainbow-caramel-df0320.netlify.app/" />
  <meta property="og:image" content="/og-image.png" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Synergia v3.5" />
  <meta name="twitter:description" content="Gamification & Productivit√© en √©quipe" />
  <meta name="twitter:image" content="/twitter-image.png" />
  
  <style>
    /* ‚≠ê CRITICAL CSS inline pour √©viter le flash */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #111827;
      color: #ffffff;
      overflow-x: hidden;
    }
    
    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    
    .loading-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .loader {
      width: 60px;
      height: 60px;
      border: 4px solid #374151;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #9ca3af;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .version-info {
      color: #6b7280;
      font-size: 12px;
      position: absolute;
      bottom: 20px;
    }
    
    /* App Container */
    #root {
      min-height: 100vh;
      background-color: #111827;
    }
    
    /* Prevent FOUC */
    .no-js #root {
      display: none;
    }
  </style>
</head>
<body>
  <!-- ‚≠ê LOADING SCREEN avec version -->
  <div id="loading-screen" class="loading-screen">
    <div class="loader"></div>
    <div class="loading-text">Chargement de Synergia...</div>
    <div class="version-info">v3.5.1</div>
  </div>
  
  <!-- React App -->
  <div id="root"></div>
  
  <!-- ‚≠ê CACHE BUSTER SCRIPT avant tout -->
  <script>
    // Version tracking et cache busting
    window.SYNERGIA_VERSION = '3.5.1';
    window.BUILD_TIME = Date.now();
    
    // Force refresh function globale
    window.forceDashboardReload = function() {
      console.log('üöÄ FORCE RELOAD: D√©but...');
      
      // Vider tous les caches
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          return Promise.all(cacheNames.map(name => caches.delete(name)));
        }).then(() => {
          console.log('‚úÖ Caches vid√©s');
          
          // Vider le storage en gardant Firebase
          try {
            const authKey = Object.keys(localStorage).find(key => 
              key.includes('firebase:authUser')
            );
            const authValue = authKey ? localStorage.getItem(authKey) : null;
            
            localStorage.clear();
            
            if (authKey && authValue) {
              localStorage.setItem(authKey, authValue);
            }
            
            sessionStorage.clear();
          } catch(e) {
            console.warn('Erreur storage:', e);
          }
          
          // Hard reload avec timestamp
          const url = new URL(window.location);
          url.searchParams.set('_cacheBust', Date.now());
          url.searchParams.set('_version', '3.5.1');
          window.location.replace(url.toString());
        });
      } else {
        // Fallback
        localStorage.clear();
        sessionStorage.clear();
        window.location.reload(true);
      }
    };
    
    // Auto-hide loading screen apr√®s timeout
    setTimeout(() => {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.classList.add('fade-out');
        setTimeout(() => {
          loadingScreen.remove();
        }, 500);
      }
    }, 3000);
    
    // Version check
    const storedVersion = localStorage.getItem('synergia_app_version');
    if (storedVersion && storedVersion !== '3.5.1') {
      console.log('üîÑ Nouvelle version d√©tect√©e, nettoyage...');
      // Ne pas vider imm√©diatement, laisser l'app se charger
    }
    localStorage.setItem('synergia_app_version', '3.5.1');
    
    // Console welcome
    console.log('%cüöÄ SYNERGIA v3.5.1', 'color: #3b82f6; font-size: 20px; font-weight: bold;');
    console.log('%cCommandes disponibles:', 'color: #10b981; font-weight: bold;');
    console.log('%c‚Ä¢ forceDashboardReload() - Force le rechargement', 'color: #6b7280;');
    console.log('%c‚Ä¢ window.location.reload(true) - Rechargement dur', 'color: #6b7280;');
  </script>
  
  <!-- ‚≠ê SERVICE WORKER REGISTRATION avec mise √† jour forc√©e -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', {
          scope: '/',
          updateViaCache: 'none' // ‚≠ê Toujours chercher les mises √† jour
        })
        .then(registration => {
          console.log('üì± SW registered:', registration.scope);
          
          // Forcer la mise √† jour du SW
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            console.log('üîÑ Nouvelle version SW d√©tect√©e');
            
            newWorker?.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('üì± SW mis √† jour, rechargement...');
                window.location.reload();
              }
            });
          });
          
          // V√©rifier les mises √† jour imm√©diatement
          registration.update();
          
          // V√©rifier p√©riodiquement
          setInterval(() => {
            registration.update();
          }, 60000); // Toutes les minutes
        })
        .catch(error => {
          console.log('‚ùå SW registration failed:', error);
        });
      });
    }
  </script>
  
  <!-- ‚≠ê VERSION TRACKER -->
  <script type="application/json" id="version-info">
    {
      "version": "3.5.1",
      "buildTime": "{{BUILD_TIME}}",
      "features": ["cache-busting", "auto-refresh", "sw-update"]
    }
  </script>
  
  <!-- ‚≠ê Main App Script SANS cache busting (Vite s'en charge) -->
  <script type="module" src="/src/index.jsx"></script>
</body>
</html>
